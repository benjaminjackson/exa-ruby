#!/usr/bin/env ruby
# frozen_string_literal: true

require "exa-ai"

# Global CLI interface for Exa API

module ExaCLI
  AVAILABLE_COMMANDS = {
    "search" => "Search the web",
    "answer" => "Generate an answer to a question",
    "context" => "Get code context from repositories",
    "get-contents" => "Retrieve page contents",
    "research-start" => "Start a research task",
    "research-get" => "Get research task status",
    "research-list" => "List research tasks",
    "webset-create" => "Create a new webset",
    "webset-get" => "Get webset details",
    "webset-list" => "List websets",
    "webset-update" => "Update a webset",
    "webset-delete" => "Delete a webset",
    "webset-cancel" => "Cancel a webset",
    "enrichment-create" => "Create an enrichment",
    "enrichment-get" => "Get enrichment details",
    "enrichment-list" => "List enrichments",
    "enrichment-update" => "Update an enrichment",
    "enrichment-delete" => "Delete an enrichment",
    "enrichment-cancel" => "Cancel an enrichment"
  }.freeze

  def self.run
    case ARGV[0]
    when "--version"
      puts Exa::VERSION
      exit 0
    when "--help", "help", "-h", nil
      print_help
      exit 0
    when "--api-key"
      puts "Use --api-key flag with specific commands"
      exit 1
    when "search"
      exec File.expand_path("../exa-ai-search", __FILE__), *ARGV[1..]
    when "answer"
      exec File.expand_path("../exa-ai-answer", __FILE__), *ARGV[1..]
    when "context"
      exec File.expand_path("../exa-ai-context", __FILE__), *ARGV[1..]
    when "get-contents"
      exec File.expand_path("../exa-ai-get-contents", __FILE__), *ARGV[1..]
    when "research-start"
      exec File.expand_path("../exa-ai-research-start", __FILE__), *ARGV[1..]
    when "research-get"
      exec File.expand_path("../exa-ai-research-get", __FILE__), *ARGV[1..]
    when "research-list"
      exec File.expand_path("../exa-ai-research-list", __FILE__), *ARGV[1..]
    when "webset-create"
      exec File.expand_path("../exa-ai-webset-create", __FILE__), *ARGV[1..]
    when "webset-get"
      exec File.expand_path("../exa-ai-webset-get", __FILE__), *ARGV[1..]
    when "webset-list"
      exec File.expand_path("../exa-ai-webset-list", __FILE__), *ARGV[1..]
    when "webset-update"
      exec File.expand_path("../exa-ai-webset-update", __FILE__), *ARGV[1..]
    when "webset-delete"
      exec File.expand_path("../exa-ai-webset-delete", __FILE__), *ARGV[1..]
    when "webset-cancel"
      exec File.expand_path("../exa-ai-webset-cancel", __FILE__), *ARGV[1..]
    when "enrichment-create"
      exec File.expand_path("../exa-ai-enrichment-create", __FILE__), *ARGV[1..]
    when "enrichment-get"
      exec File.expand_path("../exa-ai-enrichment-get", __FILE__), *ARGV[1..]
    when "enrichment-list"
      exec File.expand_path("../exa-ai-enrichment-list", __FILE__), *ARGV[1..]
    when "enrichment-update"
      exec File.expand_path("../exa-ai-enrichment-update", __FILE__), *ARGV[1..]
    when "enrichment-delete"
      exec File.expand_path("../exa-ai-enrichment-delete", __FILE__), *ARGV[1..]
    when "enrichment-cancel"
      exec File.expand_path("../exa-ai-enrichment-cancel", __FILE__), *ARGV[1..]
    else
      print_error_for_command(ARGV[0])
      exit 1
    end
  end

  def self.print_help
    puts "Exa CLI v#{Exa::VERSION}"
    puts ""
    puts "Usage: exa-ai <command> [options]"
    puts ""
    puts "Commands:"
    AVAILABLE_COMMANDS.each do |cmd, desc|
      puts "  #{cmd.ljust(20)} #{desc}"
    end
    puts ""
    puts "Global Options:"
    puts "  --help, -h         Show this help message"
    puts "  --version          Show version number"
    puts ""
    puts "Examples:"
    puts "  exa-ai search 'ruby programming'"
    puts "  exa-ai context 'React hooks' --tokens-num 5000"
    puts "  exa-ai research-start --instructions 'Find AI papers'"
  end

  def self.print_error_for_command(cmd)
    return print_help if cmd.nil?

    puts "Error: Unknown command '#{cmd}'"
    puts ""

    # Try to suggest similar commands
    suggestion = suggest_command(cmd)
    puts "Did you mean: #{suggestion}?" if suggestion

    puts ""
    puts "Run 'exa-ai --help' for usage information."
  end

  def self.suggest_command(input)
    # Simple suggestion based on string similarity
    # If first char matches and length is similar, suggest it
    input_start = input[0]
    candidates = AVAILABLE_COMMANDS.keys.select { |c| c[0] == input_start }
    candidates.first
  end
end

ExaCLI.run
