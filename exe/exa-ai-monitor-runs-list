#!/usr/bin/env ruby
# frozen_string_literal: true

require "exa-ai"

# Parse arguments
monitor_id = nil
limit = nil
cursor = nil
api_key = nil
output_format = "json"

args = ARGV.dup
while args.any?
  arg = args.shift
  case arg
  when "--limit"
    limit = args.shift&.to_i
  when "--cursor"
    cursor = args.shift
  when "--api-key"
    api_key = args.shift
  when "--output-format"
    output_format = args.shift
  when "--help", "-h"
    puts <<~HELP
      Usage: exa-ai monitor-runs-list <monitor_id> [OPTIONS]

      List execution runs for a monitor

      Arguments:
        monitor_id             ID of the monitor (required)

      Options:
        --limit N              Maximum number of runs to return (default: 25, max: 100)
        --cursor CURSOR        Cursor for pagination (use nextCursor from previous response)
        --api-key KEY          Exa API key (or set EXA_API_KEY env var)
        --output-format FMT    Output format: json, pretty, or text (default: json)
        --help, -h             Show this help message

      Examples:
        exa-ai monitor-runs-list mon_abc123
        exa-ai monitor-runs-list mon_abc123 --limit 10
        exa-ai monitor-runs-list mon_abc123 --limit 5 --cursor "abc123"
        exa-ai monitor-runs-list mon_abc123 --output-format pretty
    HELP
    exit 0
  else
    # First positional argument is monitor_id
    if monitor_id.nil?
      monitor_id = arg
    else
      $stderr.puts "Unknown option: #{arg}"
      exit 1
    end
  end
end

# Validate
if monitor_id.nil?
  $stderr.puts "Error: monitor_id argument is required"
  $stderr.puts "Usage: exa-ai monitor-runs-list <monitor_id> [OPTIONS]"
  $stderr.puts "Try 'exa-ai monitor-runs-list --help' for more information"
  exit 1
end

begin
  # Resolve API key and format
  api_key = Exa::CLI::Base.resolve_api_key(api_key)
  output_format = Exa::CLI::Base.resolve_output_format(output_format)

  # Build client
  client = Exa::CLI::Base.build_client(api_key)

  # List monitor runs with optional pagination
  list_params = {monitor_id: monitor_id}
  list_params[:limit] = limit if limit
  list_params[:cursor] = cursor if cursor

  collection = client.list_monitor_runs(**list_params)

  # Format and output
  output = Exa::CLI::Formatters::MonitorRunFormatter.format_collection(collection, output_format)
  puts output

rescue Exa::NotFound => e
  $stderr.puts "Monitor not found: #{e.message}"
  exit 1
rescue Exa::ConfigurationError => e
  $stderr.puts "Configuration error: #{e.message}"
  exit 1
rescue Exa::Unauthorized => e
  $stderr.puts "Authentication error: #{e.message}"
  $stderr.puts "Check your API key (set EXA_API_KEY or use --api-key)"
  exit 1
rescue Exa::ClientError => e
  $stderr.puts "Client error: #{e.message}"
  exit 1
rescue Exa::ServerError => e
  $stderr.puts "Server error: #{e.message}"
  $stderr.puts "The Exa API may be experiencing issues. Please try again later."
  exit 1
rescue Exa::Error => e
  $stderr.puts "Error: #{e.message}"
  exit 1
rescue StandardError => e
  $stderr.puts "Unexpected error: #{e.message}"
  $stderr.puts e.backtrace.first(5) if ENV["DEBUG"]
  exit 1
end
