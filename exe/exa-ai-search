#!/usr/bin/env ruby
# frozen_string_literal: true

require "exa-ai"
require_relative "../lib/exa/cli/search_parser"

def print_help
  puts <<~HELP
    Usage: exa-ai search QUERY [OPTIONS]

    Search the web using Exa AI

    Arguments:
      QUERY                 Search query (required)

    Options:
      --num-results N              Number of results to return (default: 10)
      --type TYPE                  Search type: fast, deep, keyword, or auto (default: fast)
      --category CAT               Focus on specific data category
                                   Options: "company", "research paper", "news", "pdf",
                                   "github", "tweet", "personal site", "financial report",
                                   "people"
      --include-domains D          Comma-separated list of domains to include
      --exclude-domains D          Comma-separated list of domains to exclude
      --start-published-date DATE  Filter by published date (ISO 8601 format)
      --end-published-date DATE    Filter by published date (ISO 8601 format)
      --start-crawl-date DATE      Filter by crawl date (ISO 8601 format)
      --end-crawl-date DATE        Filter by crawl date (ISO 8601 format)
      --include-text PHRASE        Include results with exact phrase (repeatable)
      --exclude-text PHRASE        Exclude results with exact phrase (repeatable)

    Content Extraction:
      --text                       Include full webpage text
      --text-max-characters N      Max characters for webpage text
      --include-html-tags          Include HTML tags in text extraction
      --summary                    Include AI-generated summary
      --summary-query PROMPT       Custom prompt for summary generation
      --summary-schema FILE        JSON schema for summary structure (@file syntax)
      --context                    Format results as context for LLM RAG
      --context-max-characters N   Max characters for context string
      --subpages N                 Number of subpages to crawl
      --subpage-target PHRASE      Subpage target phrases (repeatable)
      --links N                    Number of links to extract per result
      --image-links N              Number of image links to extract

    General Options:
      --api-key KEY                Exa API key (or set EXA_API_KEY env var)
      --output-format FMT          Output format: json, pretty, or text (default: json)
      --help, -h                   Show this help message

    Examples:
      exa-ai search "ruby programming"
      exa-ai search "machine learning" --num-results 5 --type deep
      exa-ai search "Latest LLM research" --category "research paper"
      exa-ai search "AI startups" --category company
      exa-ai search "Dario Amodei" --category people
      exa-ai search "AI research" --include-domains arxiv.org,scholar.google.com
      exa-ai search "tutorials" --output-format pretty
  HELP
end

# Build contents parameter from extracted flags
def build_contents(args)
  contents = {}

  # Text options
  if args[:text]
    if args[:text_max_characters] || args[:include_html_tags]
      contents[:text] = {}
      contents[:text][:max_characters] = args[:text_max_characters] if args[:text_max_characters]
      contents[:text][:include_html_tags] = args[:include_html_tags] if args[:include_html_tags]
    else
      contents[:text] = true
    end
  end

  # Summary options
  if args[:summary]
    if args[:summary_query] || args[:summary_schema]
      contents[:summary] = {}
      contents[:summary][:query] = args[:summary_query] if args[:summary_query]
      contents[:summary][:schema] = args[:summary_schema] if args[:summary_schema]
    else
      contents[:summary] = true
    end
  end

  # Context options
  if args[:context]
    if args[:context_max_characters]
      contents[:context] = { max_characters: args[:context_max_characters] }
    else
      contents[:context] = true
    end
  end

  # Subpages options
  contents[:subpages] = args[:subpages] if args[:subpages]
  contents[:subpage_target] = args[:subpage_target] if args[:subpage_target]

  # Extras options
  if args[:links] || args[:image_links]
    contents[:extras] = {}
    contents[:extras][:links] = args[:links] if args[:links]
    contents[:extras][:image_links] = args[:image_links] if args[:image_links]
  end

  contents.empty? ? nil : contents
end

# Main execution
begin
  # Handle help flag
  if ARGV.include?("--help") || ARGV.include?("-h")
    print_help
    exit 0
  end

  # Parse command-line arguments
  args = Exa::CLI::SearchParser.parse(ARGV)

  # Resolve API key
  api_key = Exa::CLI::Base.resolve_api_key(args[:api_key])

  # Resolve output format
  output_format = Exa::CLI::Base.resolve_output_format(args[:output_format])

  # Build client
  client = Exa::CLI::Base.build_client(api_key)

  # Prepare search parameters
  search_params = {}
  search_params[:numResults] = args[:num_results] if args[:num_results]
  search_params[:type] = args[:type] if args[:type]
  search_params[:category] = args[:category] if args[:category]
  search_params[:includeDomains] = args[:include_domains] if args[:include_domains]
  search_params[:excludeDomains] = args[:exclude_domains] if args[:exclude_domains]
  search_params[:start_published_date] = args[:start_published_date] if args[:start_published_date]
  search_params[:end_published_date] = args[:end_published_date] if args[:end_published_date]
  search_params[:start_crawl_date] = args[:start_crawl_date] if args[:start_crawl_date]
  search_params[:end_crawl_date] = args[:end_crawl_date] if args[:end_crawl_date]
  search_params[:include_text] = args[:include_text] if args[:include_text]
  search_params[:exclude_text] = args[:exclude_text] if args[:exclude_text]
  contents = build_contents(args)
  search_params.merge!(contents) if contents

  # Execute search
  result = client.search(args[:query], **search_params)

  # Format and output result
  output = Exa::CLI::Formatters::SearchFormatter.format(result, output_format)
  puts output
  $stdout.flush

rescue Exa::ConfigurationError => e
  $stderr.puts "Configuration error: #{e.message}"
  exit 1
rescue Exa::Unauthorized => e
  $stderr.puts "Authentication error: #{e.message}"
  $stderr.puts "Check your API key (set EXA_API_KEY or use --api-key)"
  exit 1
rescue Exa::ClientError => e
  $stderr.puts "Client error: #{e.message}"
  exit 1
rescue Exa::ServerError => e
  $stderr.puts "Server error: #{e.message}"
  $stderr.puts "The Exa API may be experiencing issues. Please try again later."
  exit 1
rescue Exa::Error => e
  $stderr.puts "Error: #{e.message}"
  exit 1
rescue StandardError => e
  $stderr.puts "Unexpected error: #{e.message}"
  $stderr.puts e.backtrace.first(5) if ENV["DEBUG"]
  exit 1
end
